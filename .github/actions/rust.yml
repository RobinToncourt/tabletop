name: build

on:
    push:
        branches:
            - 'main'

env:
    CARGO_TERM_COLOR: always

jobs:
    build:
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@v3
            - uses: actions/cache@v3
              with:
                path: |
                    ~/.cargo/bin/
                    ~/.cargo/registry/index/
                    ~/.cargo/registry/cache/
                    ~/.cargo/git/db/
                    target/
                key: ${{ github.ref || github.run_id }}
            - uses: dtolnay/rust-toolchain@stable
            - name: Install alsa and udev
              run: sudo apt-get update; sudo apt-get install --no-install-recommends libasound2-dev libudev-dev
            - name: Build
              run: cargo build --release --target wasm32-unknown-unknown && wasm-bindgen --no-typescript --out-dir ./out/ --target web ./target/wasm32-unknown-unknown/release/bevy_wasm_ci_example.wasm --out-name "tabletop" && wasm-strip ./out/tabletop_bg.wasm && wasm-opt -Oz --enable-bulk-memory --enable-nontrapping-float-to-int --enable-reference-types -o ./out/tabletop_bg.wasm ./out/tabletop_bg.wasm && gzip -f ./out/tabletop_bg.wasm
            - name: Copy
              run: cp -R assets out/ && cp www/index.html out/index.html
            - name: Push
              uses: s0/git-publish-subdir-action@develop
              env:
                SQUASH_HISTORY: true
                REPO: self
                BRANCH: gh-pages # The branch name where you want to push the assets
                FOLDER: out # The directory where your assets are generated
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub will automatically add this - you don't need to bother getting a token
                MESSAGE: "Build: ({sha}) {msg}" # The commit message
